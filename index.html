<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Anonymous Prayer Requests</title>
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Cross Loader Styles -->
  <style>
    .cross-loader {
      width: 24px;
      height: 24px;
      position: relative;
      margin: 0 auto;
    }
    .cross-loader::before,
    .cross-loader::after {
      content: "";
      position: absolute;
      background: #4f46e5; /* Tailwind indigo-600 */
      border-radius: 2px;
    }
    .cross-loader::before {
      width: 6px;
      height: 100%;
      left: 50%;
      transform: translateX(-50%);
    }
    .cross-loader::after {
      height: 6px;
      width: 100%;
      top: 50%;
      transform: translateY(-50%);
    }
    .cross-animate {
      animation: pulseCross 0.9s infinite alternate ease-in-out;
    }
    @keyframes pulseCross {
      from { opacity: 0.6; transform: scale(0.9) rotate(0deg); }
      to   { opacity: 1;   transform: scale(1.1) rotate(90deg); }
    }
  </style>
</head>
<body class="min-h-screen bg-gray-50 text-gray-900">
  <main class="max-w-xl mx-auto p-6">
    <header class="text-center my-8">
      <h1 class="text-3xl font-bold">Anonymous Prayer Requests</h1>
      <p class="mt-2 text-sm text-gray-600">“Cast all your anxiety on Him because He cares for you.” — 1 Peter 5:7</p>
    </header>

    <form id="prayerForm" class="bg-white shadow rounded-2xl p-6 space-y-5" autocomplete="off" novalidate>
      <!-- Honeypot -->
      <div class="hidden">
        <label>Leave this field empty
          <input type="text" name="website" tabindex="-1" autocomplete="off" />
        </label>
      </div>

      <div>
        <label for="message" class="block text-sm font-medium mb-1">Your request *</label>
        <textarea id="message" name="message" required rows="6" maxlength="2000"
          class="w-full rounded-xl border border-gray-300 p-3 focus:outline-none focus:ring-2 focus:ring-indigo-500"
          placeholder="Share your prayer request. No names, emails, or identifiers needed."></textarea>
        <p class="mt-1 text-xs text-gray-500">Min 10, Max 2000 characters.</p>
      </div>

      <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
        <div>
          <label for="category" class="block text-sm font-medium mb-1">Category (optional)</label>
          <select id="category" name="category" class="w-full rounded-xl border border-gray-300 p-3">
            <option value="">—</option>
            <option>Healing</option>
            <option>Guidance</option>
            <option>Provision</option>
            <option>Family</option>
            <option>School</option>
            <option>Other</option>
          </select>
        </div>
        <div>
          <label for="urgency" class="block text-sm font-medium mb-1">Urgency (optional)</label>
          <select id="urgency" name="urgency" class="w-full rounded-xl border border-gray-300 p-3">
            <option value="">—</option>
            <option>Low</option>
            <option>Normal</option>
            <option>High</option>
          </select>
        </div>
      </div>

      <div class="flex items-start gap-2">
        <input id="shareConsent" name="shareConsent" type="checkbox" class="mt-1">
        <label for="shareConsent" class="text-sm">I’m okay with this being shared privately with the Bible study prayer team.</label>
      </div>

      <button type="submit" id="submitBtn"
        class="w-full rounded-xl bg-indigo-600 text-white font-semibold py-3 hover:bg-indigo-700 transition flex items-center justify-center">
        Send Request
      </button>

      <p id="status" class="text-sm mt-2"></p>
    </form>

    <footer class="text-center text-xs text-gray-500 mt-8">
      <p>Avoid sharing personal identifiers. If this is an emergency, call local services.</p>
    </footer>
  </main>

  <!-- Client Script: cross loader + success/error UI + redirect -->
  <script>
    const form = document.getElementById('prayerForm');
    const status = document.getElementById('status');
    const submitBtn = document.getElementById('submitBtn');

    form.addEventListener('submit', async (e) => {
      e.preventDefault();
      status.textContent = '';
      status.className = 'text-sm mt-2';

      const fd = new FormData(form);
      if (fd.get('website')) return; // honeypot

      const message = (fd.get('message') || '').trim();
      const category = (fd.get('category') || '').trim();
      const urgency = (fd.get('urgency') || '').trim();
      const shareConsent = !!fd.get('shareConsent');

      if (message.length < 10) {
        status.textContent = 'Please write at least 10 characters.';
        status.className += ' text-red-600';
        return;
      }

      // Show cross loader in button
      submitBtn.disabled = true;
      const originalBtnHTML = submitBtn.innerHTML;
      submitBtn.innerHTML = '<div class="cross-loader cross-animate" aria-label="Sending…"></div>';

      try {
        const res = await fetch('/api/prayer', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ message, category, urgency, shareConsent })
        });

        const data = await res.json().catch(() => ({}));
        if (!res.ok || !data.ok) {
          throw new Error(data.error || 'Failed to send');
        }

        // Success UI + show Request ID if present
        status.innerHTML = data.id
          ? `✅ Sent! Request ID: <span class="font-mono">${data.id}</span>`
          : '✅ Thank you! Your request has been sent to the prayer team.';
        status.className += ' text-green-700';

        form.reset();

        // Redirect to Thank You page with optional ID after a brief pause
        setTimeout(() => {
          const idParam = data.id ? `?id=${encodeURIComponent(data.id)}` : '';
          location.href = '/thank-you.html' + idParam;
        }, 900);

      } catch (err) {
        status.textContent = 'Something went wrong. Please try again.';
        status.className += ' text-red-600';
      } finally {
        submitBtn.disabled = false;
        submitBtn.innerHTML = originalBtnHTML;
      }
    });
  </script>
</body>
</html>
